<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Carlos ç”Ÿæ—¥æ‘˜æ˜Ÿæ˜Ÿ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="fonts.googleapis.com" rel="stylesheet">
    <style>
        :root { --blue: #94a7ae; --gray: #e2e2e2; --bg: #f8f9fa; --text: #4a4a4a; --accent: #c5a48e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
       
        header { background: var(--blue); color: white; padding: 50px 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.2rem; letter-spacing: 2px; margin: 0; font-weight: 700; }
       
        .date-slider { display: flex; overflow-x: auto; background: white; padding: 12px; gap: 12px; border-bottom: 1px solid var(--gray); scrollbar-width: none; position: sticky; top: 85px; z-index: 90; }
        .date-slider::-webkit-scrollbar { display: none; }
        .date-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px; height: 70px; border-radius: 15px; background: #f2f2f2; border: none; flex-shrink: 0; }
        .date-btn .wk { font-size: 1rem; font-weight: 700; color: #888; }
        .date-btn .dt { font-size: 0.8rem; color: #aaa; }
        .date-btn.active { background: var(--blue); color: white; }
        .date-btn.active .wk, .date-btn.active .dt { color: white; }

        .container { padding: 15px; }
        .card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; border: 1px solid #efefef; cursor: pointer; overflow: hidden; }
        .card:active { background-color: #fcfcfc; }
       
        .card-img { width: 100%; max-height: 200px; object-fit: cover; margin-top: 10px; border-radius: 12px; border: 1px solid #eee; }

        .weather-info { background: white; border-radius: 18px; padding: 15px; margin-bottom: 18px; display: flex; align-items: center; gap: 15px; border: 1px solid #eee; }
        .city-tag { font-size: 0.7rem; background: var(--blue); color: white; padding: 2px 6px; border-radius: 5px; margin-bottom: 3px; display: inline-block; }

        .flight-card { background: linear-gradient(135deg, #4a6a75 0%, #94a7ae 100%); color: white; }
        .type-tag { font-size: 0.7rem; color: white; background: var(--accent); padding: 3px 8px; border-radius: 10px; display: inline-block; margin-bottom: 5px; }
        .addr-link { color: var(--blue); font-size: 0.85rem; text-decoration: underline; margin-top: 8px; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 0; }

        .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; z-index: 500; }
        .fab svg { width: 28px; height: 28px; stroke: white; stroke-width: 3; }
       
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-tab { flex: 1; border:none; background:none; color: #bbb; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; font-family: inherit; }
        .nav-tab.active { color: var(--blue); font-weight: bold; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-height: 85vh; border-radius: 25px; padding: 25px; overflow-y: auto; }
        input, select, textarea { width: 100%; height: 48px; padding: 12px; margin: 4px 0 12px 0; border: 1px solid #eee; border-radius: 10px; font-size: 1rem; }
        textarea { height: auto; }
        .field-lbl { display: block; font-size: 0.85rem; color: #666; font-weight: 500;}

        .img-preview-box { width: 100%; height: 120px; border: 2px dashed #eee; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 10px 0; overflow: hidden; background: #fafafa; }
        .img-preview-box img { height: 100%; width: 100%; object-fit: cover; }

        .save-btn { background: var(--blue); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: 700; margin-top: 10px; }
        .cancel-btn { width: 100%; border: none; background: none; color: #aaa; margin-top: 10px; padding: 10px; }

        .day-sum-card { background: var(--blue); color: white; padding: 12px 18px; border-radius: 15px; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .pay-method { font-size: 0.7rem; color: var(--blue); border: 1px solid var(--blue); padding: 1px 6px; border-radius: 4px; margin-right: 5px; }
        .payer-tag { font-size: 0.7rem; background: #f0f0f0; color: #666; padding: 1px 6px; border-radius: 4px; }
        .twd-amt { font-size: 0.75rem; color: #999; display: block; text-align: right; }
        .del-btn { border:none; background:none; color:#ccc; font-size:0.8rem; padding: 5px; }

    </style>
</head>
<body>

<header><div class="header-title" id="tabTitle">Carlos ç”Ÿæ—¥æ‘˜æ˜Ÿæ˜Ÿ</div></header>

<div class="date-slider" id="dateSlider"></div>
<div class="container" id="mainView"></div>

<button class="fab" id="fabBtn" onclick="openModal()">
    <svg viewBox="0 0 24 24" width="28" height="28" stroke="white" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</button>

<nav class="bottom-nav">
    <button class="nav-tab active" onclick="goTab('trip')">è¡Œç¨‹</button>
    <button class="nav-tab" onclick="goTab('todo')">TODO</button>
    <button class="nav-tab" onclick="goTab('back')">å‚™æ¡ˆ</button>
    <button class="nav-tab" onclick="goTab('wallet')">è¨˜å¸³</button>
</nav>

<div id="modal" class="modal"><div class="modal-content" id="modalInner"></div></div>

<script>
    let day = 0, tab = 'trip', editingIdx = null;
    let tempImgBase64 = ""; // æš«å­˜åœ–ç‰‡å­—ä¸²
    const store = (k, v) => v ? localStorage.setItem(k, JSON.stringify(v)) : JSON.parse(localStorage.getItem(k));
    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const fmt = (num) => Number(num).toLocaleString();
   
    let tripData = store('c_trip_final_v5') || Array(8).fill().map(()=>[]);
    let backData = store('c_back_v2') || [];
    let todoData = store('c_todo') || [];
    let wallData = store('c_wall_all') || [];
    let exchangeRate = parseFloat(localStorage.getItem('c_rate')) || 0.21;

    function goMap(e, addr) {
        e.stopPropagation();
        if (!addr) return;
        if (confirm(`æ˜¯å¦é–‹å•Ÿ Google Maps å°èˆªè‡³ï¼š\n${addr}ï¼Ÿ`)) {
            window.location.href = `www.google.com{encodeURIComponent(addr)}`;
        }
    }

    function updateRate(val) {
        exchangeRate = parseFloat(val) || 0.21;
        localStorage.setItem('c_rate', exchangeRate);
        render();
    }
   
    function formatAmount(input) {
        let value = input.value.replace(/,/g, '');
        if (!isNaN(parseFloat(value)) && isFinite(value)) {
            input.value = parseFloat(value).toLocaleString();
        }
    }

    // è™•ç†åœ–ç‰‡ä¸Šå‚³
    function handleImg(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                tempImgBase64 = e.target.result;
                document.getElementById('img_preview').src = tempImgBase64;
                document.getElementById('img_preview_box').style.display = "flex";
            };
            reader.readAsDataURL(file);
        }
    }

    function goTab(t) { tab = t; render(); }

    function render() {
        const view = document.getElementById('mainView');
        const slider = document.getElementById('dateSlider');
        const title = document.getElementById('tabTitle');
       
        slider.style.display = (tab === 'trip') ? 'flex' : 'none';
        document.querySelectorAll('.nav-tab').forEach((n,i)=>n.classList.toggle('active', ['trip','todo','back','wallet'].indexOf(tab)===i));
       
        let h = '';
        if(tab === 'trip') {
            title.innerText = "è¡Œç¨‹è¦åŠƒ";
            slider.innerHTML = '';
            for(let i=0; i<8; i++){
                let d = new Date(2025, 11, 24+i);
                slider.innerHTML += `<button class="date-btn ${i===day?'active':''}" onclick="day=${i};render()"><span class="wk">${weekdays[d.getDay()]}</span><span>${d.getDate()}</span></button>`;
            }

            let isTokyo = day >= 4;
            let city = isTokyo ? 'æ±äº¬ Tokyo' : 'åå¤å±‹ Nagoya';
            h += `<div class="weather-info" onclick="window.open('weather.yahoo.co.jp')">
                    <span class="weather-icon">â„ï¸</span>
                    <div><span class="city-tag">${city}</span><div style="font-weight:700">é ä¼° 3Â°C ~ 10Â°C</div></div>
                  </div>`;
           
            if(day === 0) {
                h += `<div class="card flight-card" onclick="goMap(event, 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´')">
                    <div style="font-size:0.8rem; opacity:0.8; margin-bottom:5px;">è¯èˆª CI154 | 12/24 DEPARTURE</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.8rem; font-weight:700;">TPE</span><span style="font-size:1.2rem;">âœˆï¸</span><span style="font-size:1.8rem; font-weight:700;">NGO</span>
                    </div><div style="font-size:0.95rem; margin-top:10px;">07:35 èµ·é£› - 11:05 æŠµé” (2.5hr)</div></div>`;
            }

            if(day === 7) {
                 h += `<div class="card flight-card" onclick="goMap(event, 'æˆç”°åœ‹éš›æ©Ÿå ´')">
                    <div style="font-size:0.8rem; opacity:0.8; margin-bottom:5px;">è¯èˆª CI109 | 12/31 RETURN</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.8rem; font-weight:700;">NRT</span><span style="font-size:1.2rem;">âœˆï¸</span><span style="font-size:1.8rem; font-weight:700;">TPE</span>
                    </div><div style="font-size:0.95rem; margin-top:10px;">19:30 èµ·é£› - 22:45 æŠµé” (4.25hr)</div></div>`;
            }
           
            tripData[day].forEach((item, idx) => {
                h += `<div class="card" onclick="openModal(${idx})">
                    <span class="type-tag">${item.type || 'æ™¯é»'}</span>
                    <div style="font-weight:700; font-size:1.1rem; margin-top:5px;">${item.time} ${item.title}</div>
                    ${item.img ? `<img src="${item.img}" class="card-img">` : ''}
                    ${item.loc ? `<div class="addr-link" onclick="goMap(event, '${item.title} ${item.loc}')">ğŸ“ ${item.loc}</div>` : ''}
                    ${item.note ? `<div style="font-size:0.85rem; color:#666; margin-top:8px; background:#f9f9f9; padding:8px; border-radius:8px;">${item.note}</div>` : ''}
                    <div style="margin-top:10px; text-align:right;"><button class="del-btn" onclick="event.stopPropagation(); deleteItem(${idx})">åˆªé™¤</button></div>
                </div>`;
            });
        } else if(tab === 'todo') {
            title.innerText = "TODO æ¸…å–®";
            todoData.forEach((item, idx) => {
                h += `<div class="card" onclick="openModal(${idx})" style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" ${item.done?'checked':''} onclick="event.stopPropagation(); toggleTodo(${idx})" style="width:20px; height:20px; margin:0;">
                            <span style="${item.done?'text-decoration:line-through;color:#ccc':''}">${item.txt}</span>
                        </div>
                        <button class="del-btn" onclick="event.stopPropagation(); deleteTodo(${idx})">åˆªé™¤</button>
                      </div>`;
            });
        } else if(tab === 'back') {
            title.innerText = "å‚™æ¡ˆå£è¢‹åå–®";
            backData.forEach((item, idx) => {
                h += `<div class="card" onclick="openModal(${idx})">
                        <div style="font-weight:700;">${item.title}</div>
                        ${item.loc ? `<div class="addr-link" onclick="goMap(event, '${item.title} ${item.loc}')">ğŸ“ ${item.loc}</div>` : ''}
                        <div style="margin-top:10px; text-align:right;"><button class="del-btn" onclick="event.stopPropagation(); deleteBack(${idx})">åˆªé™¤</button></div>
                      </div>`;
            });
        } else if(tab === 'wallet') {
            title.innerText = "æ¶ˆè²»è¨˜å¸³";
            let totalAll = wallData.reduce((a,b)=>a+Number(b.amt), 0);
            h += `<div class="card" style="padding:12px; display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.9rem; font-weight:700;">åŒ¯ç‡:</span>
                    <input type="number" step="0.001" value="${exchangeRate}" onchange="updateRate(this.value)" style="margin:0; height:36px; flex:1;">
                  </div>`;
            let grouped = {};
            wallData.forEach(item => { if(!grouped[item.date]) grouped[item.date] = []; grouped[item.date].push(item); });
            Object.keys(grouped).sort().forEach(date => {
                let daySum = grouped[date].reduce((a,b)=>a+Number(b.amt), 0);
                h += `<div class="day-sum-card"><span>${date}</span><span>Â¥ ${fmt(daySum)}</span></div>`;
                grouped[date].forEach((item) => {
                    let globalIdx = wallData.indexOf(item);
                    h += `<div class="card" onclick="openModal(${globalIdx})" style="display:flex; flex-direction:column; gap:5px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div><div style="font-weight:700;">${item.desc}</div><span class="pay-method">${item.method}</span> <span class="payer-tag">${item.payer}</span></div>
                                <div style="text-align:right;"><div style="font-weight:700; color:var(--blue);">Â¥ ${fmt(item.amt)}</div><span class="twd-amt">â‰ˆ NT$ ${fmt(Math.round(item.amt * exchangeRate))}</span></div>
                            </div>
                            <div style="text-align:left;"><button class="del-btn" onclick="event.stopPropagation(); deleteWall(${globalIdx})">åˆªé™¤</button></div>
                          </div>`;
                });
            });
            h += `<div style="background:var(--accent); color:white; padding:18px; border-radius:18px; margin-top:20px; text-align:center;">
                    <div style="font-size:0.85rem; opacity:0.9;">ç¸½è¨ˆç´¯è¨ˆ</div>
                    <div style="font-size:1.6rem; font-weight:700; margin:5px 0;">Â¥ ${fmt(totalAll)}</div>
                    <div style="font-size:0.95rem; opacity:0.8;">ç´„ NT$ ${fmt(Math.round(totalAll * exchangeRate))}</div>
                  </div>`;
        }
        view.innerHTML = h || `<div style="text-align:center; color:#ccc; margin-top:50px;">é»æ“Šå³ä¸‹è§’ + é–‹å§‹è¨˜éŒ„</div>`;
    }

    function openModal(idx = null) {
        editingIdx = idx;
        const m = document.getElementById('modal');
        const inner = document.getElementById('modalInner');
        m.style.display = 'flex';
       
        if(tab === 'trip') {
            const data = idx !== null ? tripData[day][idx] : {type:'æ™¯é»', title:'', time:'09:00', loc:'', note:'', img:''};
            tempImgBase64 = data.img || ""; // åˆå§‹åŒ–åœ–ç‰‡æš«å­˜
            inner.innerHTML = `
                <h3>${idx !== null ? 'ä¿®æ”¹' : 'æ–°å¢'}è¡Œç¨‹</h3>
                <label class="field-lbl">è¡Œç¨‹åˆ†é¡</label><select id="f_type">
                    ${['é¤å»³','å’–å•¡å»³','è³¼ç‰©','æ™¯é»','ä½å®¿','äº¤é€š','å…¶ä»–'].map(t=>`<option ${data.type===t?'selected':''}>${t}</option>`).join('')}
                </select>
                <label class="field-lbl">åœ°é»åç¨±</label><input id="f_title" value="${data.title}">
                <label class="field-lbl">æŠµé”æ™‚é–“</label><input id="f_time" type="time" value="${data.time}">
                <label class="field-lbl">åœ°å€</label><input id="f_loc" value="${data.loc}">
                <label class="field-lbl">å‚™è¨»</label><textarea id="f_note" rows="2">${data.note}</textarea>
               
                <label class="field-lbl">åœ–ç‰‡ä¸Šå‚³ (é£¯åº—é è¨‚/QR Code)</label>
                <div class="img-preview-box" id="img_preview_box" style="display: ${tempImgBase64 ? 'flex' : 'none'}">
                    <img id="img_preview" src="${tempImgBase64}">
                </div>
                <input type="file" accept="image/*" onchange="handleImg(this)" style="padding: 10px 0; border: none; height: auto;">
                ${tempImgBase64 ? '<button onclick="tempImgBase64=\'\'; document.getElementById(\'img_preview_box\').style.display=\'none\';" style="background:none; border:none; color:red; font-size:0.8rem; margin-bottom:10px;">ç§»é™¤åœ–ç‰‡</button>' : ''}

                <button class="save-btn" onclick="saveTrip()">${idx !== null ? 'æ›´æ–°' : 'å„²å­˜'}</button>
                <button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        } else if(tab === 'todo') {
            const data = idx !== null ? todoData[idx] : {txt:''};
            inner.innerHTML = `<h3>${idx !== null ? 'ä¿®æ”¹' : 'æ–°å¢'} TODO</h3><input id="f1" value="${data.txt}"><button class="save-btn" onclick="saveTodo()">å„²å­˜</button><button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        } else if(tab === 'back') {
            const data = idx !== null ? backData[idx] : {title:'', loc:''};
            inner.innerHTML = `<h3>${idx !== null ? 'ä¿®æ”¹' : 'æ–°å¢'}å‚™æ¡ˆ</h3><input id="f1" value="${data.title}"><input id="f2" value="${data.loc}"><button class="save-btn" onclick="saveBack()">å„²å­˜</button><button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        } else if(tab === 'wallet') {
            const data = idx !== null ? wallData[idx] : {date:'2025-12-24', method:'ç¾é‡‘', payer:'Carlos', desc:'', amt:''};
            inner.innerHTML = `
                <h3>${idx !== null ? 'ä¿®æ”¹' : 'æ–°å¢'}è¨˜å¸³</h3>
                <label class="field-lbl">æ—¥æœŸ</label><input id="w1" type="date" value="${data.date}">
                <label class="field-lbl">ä»˜æ¬¾æ–¹å¼</label><select id="w2">${['ç¾é‡‘','åˆ·å¡','äº¤é€šå¡'].map(m=>`<option ${data.method===m?'selected':''}>${m}</option>`).join('')}</select>
                <label class="field-lbl">æ”¯ä»˜äºº</label><select id="w3">${['Carlos','Ivy'].map(p=>`<option ${data.payer===p?'selected':''}>${p}</option>`).join('')}</select>
                <label class="field-lbl">èªªæ˜</label><input id="w4" value="${data.desc}">
                <label class="field-lbl">é‡‘é¡(JPY)</label><input id="w5" type="text" oninput="formatAmount(this)" value="${data.amt ? fmt(data.amt) : ''}" placeholder="æ—¥å¹£é‡‘é¡">
                <button class="save-btn" onclick="saveWall()">å„²å­˜å¸³ç›®</button><button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; editingIdx = null; tempImgBase64 = ""; }
   
    function saveTrip() {
        const item = { 
            type: document.getElementById('f_type').value, 
            title: document.getElementById('f_title').value, 
            time: document.getElementById('f_time').value, 
            loc: document.getElementById('f_loc').value, 
            note: document.getElementById('f_note').value,
            img: tempImgBase64 // å„²å­˜æš«å­˜çš„åœ–ç‰‡å­—ä¸²
        };
        if(!item.title) return;
        if(editingIdx !== null) tripData[day][editingIdx] = item; else tripData[day].push(item);
        tripData[day].sort((a,b)=>a.time.localeCompare(b.time));
        store('c_trip_final_v5', tripData); closeModal(); render();
    }
    function saveTodo() {
        const txt = document.getElementById('f1').value;
        if(!txt) return;
        if(editingIdx !== null) todoData[editingIdx].txt = txt; else todoData.push({txt, done:false});
        store('c_todo', todoData); closeModal(); render();
    }
    function toggleTodo(idx) { todoData[idx].done = !todoData[idx].done; store('c_todo', todoData); render(); }
    function saveBack() {
        const title = document.getElementById('f1').value, loc = document.getElementById('f2').value;
        if(!title) return;
        if(editingIdx !== null) backData[editingIdx] = {title, loc}; else backData.push({title, loc});
        store('c_back_v2', backData); closeModal(); render();
    }
    function saveWall() {
        const amtInput = document.getElementById('w5').value.replace(/,/g, ''); 
        const item = { date: document.getElementById('w1').value, method: document.getElementById('w2').value, payer: document.getElementById('w3').value, desc: document.getElementById('w4').value, amt: Number(amtInput) };
        if(!item.desc || !item.amt) return;
        if(editingIdx !== null) wallData[editingIdx] = item; else wallData.push(item);
        store('c_wall_all', wallData); closeModal(); render();
    }
    function deleteItem(idx) { if(confirm('ç¢ºå®šåˆªé™¤è¡Œç¨‹ï¼Ÿ')) { tripData[day].splice(idx,1); store('c_trip_final_v5', tripData); render(); } }
    function deleteBack(idx) { if(confirm('ç¢ºå®šåˆªé™¤å‚™æ¡ˆï¼Ÿ')) { backData.splice(idx,1); store('c_back_v2', backData); render(); } }
    function deleteWall(idx) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { wallData.splice(idx,1); store('c_wall_all', wallData); render(); } }
    function deleteTodo(idx) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) { todoData.splice(idx,1); store('c_todo', todoData); render(); } }

    render();
</script>
</body>
</html>
