<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Carlos Bday Trip</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="fonts.googleapis.com" rel="stylesheet">
    <script src="cdn.jsdelivr.net"></script>
    <style>
        :root { --blue: #94a7ae; --gray: #e2e2e2; --bg: #f8f9fa; --text: #4a4a4a; --accent: #c5a48e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        
        header { background: var(--blue); color: white; padding: 50px 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .date-slider { display: flex; overflow-x: auto; background: white; padding: 12px; gap: 10px; border-bottom: 1px solid var(--gray); scrollbar-width: none; position: sticky; top: 85px; z-index: 90; }
        .date-slider::-webkit-scrollbar { display: none; }
        .date-btn { padding: 8px 18px; border-radius: 20px; background: #eee; font-size: 0.8rem; flex-shrink: 0; cursor: pointer; border:none; color: #777; }
        .date-btn.active { background: var(--blue); color: white; }

        .container { padding: 15px; }
        .card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; border: 1px solid #efefef; }
        
        /* è¨˜å¸³å°ˆç”¨æ¨£å¼ */
        .day-sum-card { background: var(--blue); color: white; padding: 12px 18px; border-radius: 15px; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .wallet-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        .pay-method { font-size: 0.7rem; color: var(--blue); border: 1px solid var(--blue); padding: 1px 6px; border-radius: 4px; margin-right: 5px; }
        .twd-amt { font-size: 0.75rem; color: #999; display: block; text-align: right; }

        .fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; z-index: 500; }
        .fab svg { width: 30px; height: 30px; stroke: white; stroke-width: 3; stroke-linecap: round; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-height: 85vh; border-radius: 25px; padding: 25px; overflow-y: auto; }
        .field-lbl { font-size: 0.8rem; color: #888; margin: 12px 0 4px 4px; display: block; }
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 5px; border: 1px solid #eee; border-radius: 12px; font-family: inherit; font-size: 1rem; background: #fcfcfc; }
        .save-btn { background: var(--blue); color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; margin-top: 20px; font-weight: 700; font-size: 1rem; }
        .cancel-btn { width: 100%; border: none; background: none; color: #aaa; margin-top: 15px; padding: 10px; font-size: 0.9rem; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-tab { flex: 1; border:none; background:none; color: #bbb; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-family: inherit; }
        .nav-tab.active { color: var(--blue); font-weight: bold; }
        
        .del-btn-mini { border:none; background:none; color:#ddd; margin-left:10px; }
    </style>
</head>
<body>

<header>
    <h1 style="font-size:1.1rem; letter-spacing:1px; margin:0;">Carlos Bday Trip</h1>
</header>

<div class="date-slider" id="dateSlider"></div>
<div class="container" id="mainView"></div>

<button class="fab" id="fabBtn" onclick="openModal()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</button>

<nav class="bottom-nav">
    <button class="nav-tab active" onclick="goTab('trip')">è¡Œç¨‹</button>
    <button class="nav-tab" onclick="goTab('todo')">TODO</button>
    <button class="nav-tab" onclick="goTab('wallet')">è¨˜å¸³</button>
</nav>

<div id="modal" class="modal">
    <div class="modal-content" id="modalInner"></div>
</div>

<script>
    let day = 0, tab = 'trip';
    const store = (key, val) => val ? localStorage.setItem(key, JSON.stringify(val)) : JSON.parse(localStorage.getItem(key));
    
    let tripData = store('c_trip') || Array(8).fill().map(()=>[]);
    let wallData = store('c_wall_global') || []; // æ”¹ç‚ºå…¨åŸŸæ¸…å–®
    let todoData = store('c_todo') || [];
    let exchangeRate = parseFloat(localStorage.getItem('c_rate')) || 0.21;

    const save = () => { 
        store('c_trip', tripData); 
        store('c_wall_global', wallData); 
        store('c_todo', todoData); 
        localStorage.setItem('c_rate', exchangeRate);
    };

    function goTab(t) { tab = t; render(); }

    function render() {
        const view = document.getElementById('mainView');
        const slider = document.getElementById('dateSlider');
        const fab = document.getElementById('fabBtn');
        
        slider.style.display = (tab === 'trip') ? 'flex' : 'none';
        fab.style.display = (tab === 'todo' || tab === 'trip' || tab === 'wallet') ? 'flex' : 'none';

        if(tab === 'trip') {
            slider.innerHTML = '';
            for(let i=0; i<8; i++) {
                slider.innerHTML += `<button class="date-btn ${i===day?'active':''}" onclick="day=${i};render()">12/${24+i} D${i+1}</button>`;
            }
        }

        document.querySelectorAll('.nav-tab').forEach((n,i)=>n.classList.toggle('active', ['trip','todo','wallet'].indexOf(tab)===i));

        let h = '';
        if(tab === 'trip') {
            h = `<div id="drag-list">`;
            tripData[day].forEach((it, i) => {
                h += `
                <div class="card">
                    <button style="position:absolute;right:15px;top:15px;border:none;background:none;color:#ddd;" onclick="delIt(${i})">âœ•</button>
                    <span class="type-tag">${it.type}</span>
                    <span class="time-label">ğŸ•’ ${it.time || 'æœªå®šæ™‚'}</span>
                    <div style="font-weight:700; font-size:1.1rem; margin-top:5px;">${it.title}</div>
                    ${it.addr ? `<div style="font-size:0.8rem;color:#888;text-decoration:underline;margin-top:5px;" onclick="window.open('www.google.com{encodeURIComponent(it.addr)}')">ğŸ“ ${it.addr}</div>` : ''}
                    ${it.note ? `<div style="font-size:0.85rem; color:#666; margin-top:10px; border-top:1px dashed #eee; padding-top:10px; white-space:pre-line;">${it.note}</div>` : ''}
                </div>`;
            });
            h += `</div>`;
            view.innerHTML = h;
            if(document.getElementById('drag-list')) {
                new Sortable(document.getElementById('drag-list'), { animation: 150, onEnd: (e) => {
                    let items = tripData[day];
                    let [moved] = items.splice(e.oldIndex, 1);
                    items.splice(e.newIndex, 0, moved);
                    save();
                }});
            }
        } else if(tab === 'todo') {
            h = `<div class="card"><h3>å¾…è¾¦äº‹é …</h3>`;
            todoData.forEach((t, i) => {
                h += `<div style="display:flex; align-items:center; padding:10px 0; border-bottom:1px solid #f0f0f0;">
                    <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                    <span style="flex:1">${t}</span>
                    <button onclick="todoData.splice(${i},1);save();render()" style="border:none; background:none; color:#ccc;">âœ•</button>
                </div>`;
            });
            h += `</div>`;
            view.innerHTML = h;
        } else if(tab === 'wallet') {
            h = `<div class="card" style="margin-bottom:20px;">
                <span class="field-lbl">å…Œæ›åŒ¯ç‡ (JPY 1 = TWD)</span>
                <input type="number" step="0.001" id="rateInput" value="${exchangeRate}" onchange="exchangeRate=this.value;save();render()">
            </div>`;
            
            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groups = wallData.reduce((acc, curr) => {
                acc[curr.date] = acc[curr.date] || [];
                acc[curr.date].push(curr);
                return acc;
            }, {});

            let grandTotalJPY = 0;
            Object.keys(groups).sort().forEach(d => {
                let dayTotal = groups[d].reduce((a,b)=>a+Number(b.amt),0);
                grandTotalJPY += dayTotal;
                h += `<div class="day-sum-card">
                    <span>${d} å°è¨ˆ</span>
                    <span>Â¥${dayTotal} / NT$${(dayTotal*exchangeRate).toFixed(0)}</span>
                </div>`;
                groups[d].forEach((w, idx) => {
                    h += `<div class="card" style="margin-bottom:8px; padding:12px 18px;">
                        <div class="wallet-item">
                            <span><span class="pay-method">${w.pay}</span><b style="color:var(--blue)">${w.who}</b> ${w.name}</span>
                            <span style="text-align:right">
                                <b>Â¥${w.amt}</b>
                                <span class="twd-amt">â‰ˆ NT$${(w.amt*exchangeRate).toFixed(0)}</span>
                            </span>
                            <button class="del-btn-mini" onclick="deleteExpense('${w.id}')">âœ•</button>
                        </div>
                    </div>`;
                });
            });

            h += `<div class="card" style="background:#4a4a4a; color:white; margin-top:30px; text-align:center;">
                <div style="font-size:0.8rem;">æœ¬æ¬¡æ—…è¡Œç¸½æ”¯å‡ºçµ±è¨ˆ</div>
                <div style="font-size:1.6rem; font-weight:700; margin-top:5px;">Â¥${grandTotalJPY} / NT$${(grandTotalJPY*exchangeRate).toFixed(0)}</div>
            </div>`;
            view.innerHTML = h;
        }
    }

    function openModal() {
        const inner = document.getElementById('modalInner');
        if(tab === 'trip') {
            inner.innerHTML = `
                <h3>æ–°å¢è¡Œç¨‹</h3>
                <span class="field-lbl">åˆ†é¡</span>
                <select id="m_type"><option>æ™¯é»</option><option>ç¾é£Ÿ</option><option>äº¤é€š</option><option>èˆªç­</option><option>è³¼ç‰©</option></select>
                <span class="field-lbl">åœ°é»åç¨±</span><input type="text" id="m_title">
                <span class="field-lbl">æ™‚é–“è¨­å®š</span><input type="time" id="m_time">
                <span class="field-lbl">åœ°å€</span><input type="text" id="m_addr">
                <span class="field-lbl">å‚™è¨»</span><textarea id="m_note" rows="3"></textarea>
                <button class="save-btn" onclick="addTr()">å„²å­˜è¡Œç¨‹</button>
                <button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        } else if(tab === 'todo') {
            inner.innerHTML = `<h3>æ–°å¢ TODO</h3><input type="text" id="m_t"><button class="save-btn" onclick="addTd()">æ–°å¢</button><button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        } else {
            inner.innerHTML = `<h3>æ–°å¢é–‹æ”¯</h3>
                <span class="field-lbl">æ—¥æœŸ</span>
                <select id="m_w_d">
                    <option value="2025-12-24">12/24 Day 1</option><option value="2025-12-25">12/25 Day 2</option>
                    <option value="2025-12-26">12/26 Day 3</option><option value="2025-12-27">12/27 Day 4</option>
                    <option value="2025-12-28">12/28 Day 5</option><option value="2025-12-29">12/29 Day 6</option>
                    <option value="2025-12-30">12/30 Day 7</option><option value="2025-12-31">12/31 Day 8</option>
                </select>
                <span class="field-lbl">æ”¯ä»˜äºº</span><select id="m_w_who"><option>Carlos</option><option>Ivy</option></select>
                <span class="field-lbl">ä»˜æ¬¾æ–¹å¼</span><select id="m_w_p"><option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡</option><option>äº¤é€šå¡</option></select>
                <span class="field-lbl">å“é …åç¨±</span><input type="text" id="m_w_n">
                <span class="field-lbl">æ—¥å¹£é‡‘é¡ (JPY)</span><input type="number" id="m_w_a">
                <button class="save-btn" onclick="addWa()">å„²å­˜ç´€éŒ„</button>
                <button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>`;
        }
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    function addTr() {
        tripData[day].push({ type: document.getElementById('m_type').value, title: document.getElementById('m_title').value || 'æœªå‘½å', time: document.getElementById('m_time').value, addr: document.getElementById('m_addr').value, note: document.getElementById('m_note').value });
        save(); render(); closeModal();
    }
    
    function addTd() { todoData.push(document.getElementById('m_t').value); save(); render(); closeModal(); }
    
    function addWa() {
        const item = {
            id: Date.now().toString(),
            date: document.getElementById('m_w_d').value,
            who: document.getElementById('m_w_who').value,
            pay: document.getElementById('m_w_p').value,
            name: document.getElementById('m_w_n').value || 'æœªå‘½åé–‹æ”¯',
            amt: document.getElementById('m_w_a').value || 0
        };
        wallData.push(item);
        save(); render(); closeModal();
    }

    function deleteExpense(id) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) {
            wallData = wallData.filter(item => item.id !== id);
            save(); render();
        }
    }

    function delIt(i) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { tripData[day].splice(i,1); save(); render(); } }

    render();
</script>
</body>
</html>
